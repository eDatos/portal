<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
        http://cocoon.apache.org/schema/configurator http://cocoon.apache.org/schema/configurator/cocoon-configurator-1.1.0.xsd">

    
    <!-- Common configuration -->
    <import resource="classpath:spring/droids/droids-core-context-common.xml" />
    
    
    <!-- ****************************************************************
                    Infrastructure for EUSTAT 
         **************************************************************** -->
    
    <!-- Queue -->
    <bean name="eustatQueue" class="com.stat4you.crawler.droids.impl.Stat4youSimpleTaskQueueWithHistory"/>

    <!-- Simple Task Master, use MultiThreadedTaskMaster if you desire better performance (Multiple connections to providers) -->
    <bean name="eustatTaskMaster" class="org.apache.droids.impl.SequentialTaskMaster">
        <property name="exceptionHandler" ref="taskExceptionHandler" />
        <property name="delayTimer" ref="delayTimer" />
    </bean>
    
    <!-- Parsers: The ParserFactory will lookup a parser by its identifier (content type) and return it. -->
    
    <!--  HTML parser  -->
    <bean id="eustatHtmlParser" name="text/html" class="com.stat4you.crawler.droids.parse.html.EustatHtmlParser">
        <property name="elements">
            <map>
                <entry key="a" value="href" />
                <entry key="link" value="href" />
                <entry key="img" value="src" />
                <entry key="script" value="src" />
                <entry key="option" value="value" />
            </map>
        </property>
        <property name="crawlerInfo" ref="eustatCrawlerInfo" />
        <property name="forceModeFilter" ref="eustatForceModeFilter" />
    </bean>

    <!-- Crawler Information -->
    <bean name="eustatCrawlerInfo" class="com.stat4you.crawler.util.CrawlerInfo">
        <property name="crawlerName" value="EUSTAT" />
        <property name="providerUrl" value="${stat4you.crawler.droids.provider.eustat.url}" />
        <property name="fileRepositoryIndex" ref="eustatFileRepositoryIndex" />        
    </bean>
    
    <!-- Repository Index -->
    <bean name="eustatFileRepositoryIndex" class="com.stat4you.crawler.util.FileRepositoryIndex">
        <property name="crawlerInfo" ref="eustatCrawlerInfo" />
    </bean>

    <!-- Filter -->
    <bean name="eustatFilter" class="org.apache.droids.net.RegexURLFilter">
        <property name="file" value="classpath:/regex-urlfilter-eustat.txt" />
    </bean>
    
    <bean name="eustatForceModeFilter" class="org.apache.droids.net.RegexURLFilter">
        <property name="file" value="classpath:/regex-urlfilter-eustat-forcemode.txt" />
    </bean>

    <!-- Handler -->
    <bean name="eustatSavePxHandler" class="com.stat4you.crawler.droids.handle.SavePxHandler">
        <property name="outputDir" value="${stat4you.crawler.droids.handler.save.dir}" />
        <property name="includeHost" value="true" />
        <property name="crawlerInfo" ref="eustatCrawlerInfo" />
    </bean>
        
    <bean name="eustatPxHandler" class="com.stat4you.crawler.droids.handle.PxHandler">
        <property name="crawlerInfo" ref="eustatCrawlerInfo" />
    </bean>



    <!-- Factories  -->

    <!-- Parsers -->
    <bean name="eustatParserFactory" class="org.apache.droids.helper.factories.ParserFactory">
        <property name="map">
            <map>
                <entry key="text/html" value-ref="eustatHtmlParser"></entry>
                <entry key="text/plain" value-ref="documentParser"></entry>
                <entry key="application/unknow" value-ref="documentParser"></entry>
                <entry key="application/px" value-ref="documentParser"></entry>             
            </map>
        </property>
    </bean>


    <!-- Filters -->
    <bean id="eustatFiltersFactory" class="org.apache.droids.helper.factories.URLFiltersFactory">
        <property name="map">
            <map>
                <entry key="org.apache.droids.net.RegexURLFilter" value-ref="eustatFilter"></entry>          
            </map>
        </property>
    </bean>
 
    <!-- Handlers -->
    <bean id="eustatHandlerFactory" class="com.stat4you.crawler.droids.helper.factories.HandlerFactoryStat4you">
        <property name="map">
            <map>
                <entry key="savePxHandler" value-ref="eustatSavePxHandler"></entry>
<!--                 <entry key="pxHandler" value-ref="eustatPxHandler"></entry> -->
            </map>
        </property>
    </bean>
    
    <!-- TODO THIS is a FIX for EUSTAT, delete this when the EUSTAT PX page: the original code line is corrected. -->
    <!--  See: http://jira.arte-consultores.com/browse/SFY-530 -->
    <!-- Protocols -->
    <bean name="eustatHttp" class="com.stat4you.crawler.droids.protocol.http.HttpProtocolEustatFix" scope="singleton">
        <constructor-arg ref="pxDroidsHttpClient"/>
        
        <property name="userAgent" value="DROIDS-crawler-x-m01y08" />
        <property name="forceAllow" value="${stat4you.crawler.droids.protocol.http.force}" />
    </bean>
    <bean id="eustatProtocolFactory" class="org.apache.droids.helper.factories.ProtocolFactory">
        <property name="map">
            <map>
                <entry key="http" value-ref="eustatHttp"></entry>          
            </map>
        </property>
    </bean>
    <!-- END FIX -->
 
 
    <!-- Droid -->
    <bean name="eustatCrawler" class="com.stat4you.crawler.droids.impl.Stat4youPxCrawlingDroid">
        <constructor-arg ref="eustatQueue" />
        <constructor-arg ref="eustatTaskMaster" />
        <property name="handlerFactory" ref="eustatHandlerFactory" />
        <!-- TODO THIS is a FIX for EUSTAT, delete this when the EUSTAT PX page: the original code line is corrected. -->
        <!--  See: http://jira.arte-consultores.com/browse/SFY-530 -->
        <!-- When remove this fix the line below would be <property name="protocolFactory" ref="org.apache.droids.helper.factories.ProtocolFactory" /> -->
        <property name="protocolFactory" ref="eustatProtocolFactory" />
        <property name="parserFactory" ref="eustatParserFactory" />
        <property name="filtersFactory" ref="eustatFiltersFactory" />
        
        <property name="crawlerInfo" ref="eustatCrawlerInfo" />
    </bean>


</beans>

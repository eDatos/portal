<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
        http://cocoon.apache.org/schema/configurator http://cocoon.apache.org/schema/configurator/cocoon-configurator-1.1.0.xsd">

    
    <!-- Common configuration -->
    <import resource="classpath:spring/droids/droids-core-context-common.xml" />
    
    
    <!-- ****************************************************************
                    Infrastructure for IBESTAT 
         **************************************************************** -->
    
    <!-- Queue -->
    <bean name="ibestatQueue" class="com.stat4you.crawler.droids.impl.Stat4youSimpleTaskQueueWithHistory"/>

    <!-- Simple Task Master, use MultiThreadedTaskMaster if you desire better performance (Multiple connections to providers) -->
    <bean name="ibestatTaskMaster" class="org.apache.droids.impl.SequentialTaskMaster">
        <property name="exceptionHandler" ref="taskExceptionHandler" />
        <property name="delayTimer" ref="delayTimer" />
    </bean>
    
    <!-- Parsers: The ParserFactory will lookup a parser by its identifier (content type) and return it. -->
    
    <!--  HTML parser  -->
    <bean id="ibestatHtmlParser" name="text/html" class="com.stat4you.crawler.droids.parse.html.IbestatHtmlParser">
        <property name="elements">
            <map>
                <entry key="a" value="href" />
                <entry key="link" value="href" />
                <entry key="img" value="src" />
                <entry key="script" value="src" />
                <entry key="option" value="value" />
            </map>
        </property>
        <property name="crawlerInfo" ref="ibestatCrawlerInfo" />
        <property name="forceModeFilter" ref="ibestatForceModeFilter" />
    </bean>

    <!-- Crawler Information -->
    <bean name="ibestatCrawlerInfo" class="com.stat4you.crawler.util.CrawlerInfo">
        <property name="crawlerName" value="IBESTAT" />
        <property name="providerUrl" value="${stat4you.crawler.droids.provider.ibestat.url}" />
        <property name="fileRepositoryIndex" ref="ibestatFileRepositoryIndex" />
    </bean>
    
    <!-- Repository Index -->
    <bean name="ibestatFileRepositoryIndex" class="com.stat4you.crawler.util.FileRepositoryIndex">
        <property name="crawlerInfo" ref="ibestatCrawlerInfo" />
    </bean>

    <!-- Filter -->
    <bean name="ibestatFilter" class="org.apache.droids.net.RegexURLFilter">
        <property name="file" value="classpath:/regex-urlfilter-ibestat.txt" />
    </bean>

    <bean name="ibestatForceModeFilter" class="org.apache.droids.net.RegexURLFilter">
        <property name="file" value="classpath:/regex-urlfilter-ibestat-forcemode.txt" />
    </bean>
    
    <!-- Handler -->
    <bean name="ibestatSavePxHandler" class="com.stat4you.crawler.droids.handle.SavePxHandler">
        <property name="outputDir" value="${stat4you.crawler.droids.handler.save.dir}" />
        <property name="includeHost" value="true" />
        <property name="crawlerInfo" ref="ibestatCrawlerInfo" />
    </bean>

    <bean name="ibestatPxHandler" class="com.stat4you.crawler.droids.handle.PxHandler">
        <property name="crawlerInfo" ref="ibestatCrawlerInfo" />
    </bean>



    <!-- Factories  -->

    <!-- Parsers -->
    <bean name="ibestatParserFactory" class="org.apache.droids.helper.factories.ParserFactory">
        <property name="map">
            <map>
                <entry key="text/html" value-ref="ibestatHtmlParser"></entry>
                <entry key="text/plain" value-ref="documentParser"></entry>
                <entry key="application/unknow" value-ref="documentParser"></entry>
                <entry key="application/px" value-ref="documentParser"></entry>             
            </map>
        </property>
    </bean>


    <!-- Filters -->
    <bean id="ibestatFiltersFactory" class="org.apache.droids.helper.factories.URLFiltersFactory">
        <property name="map">
            <map>
                <entry key="org.apache.droids.net.RegexURLFilter" value-ref="ibestatFilter"></entry>          
            </map>
        </property>
    </bean>
 
     <!-- Handlers -->
    <bean id="ibestatHandlerFactory" class="com.stat4you.crawler.droids.helper.factories.HandlerFactoryStat4you">
        <property name="map">
            <map>
                <entry key="savePxHandler" value-ref="ibestatSavePxHandler"></entry>
<!--                 <entry key="pxHandler" value-ref="ibestatPxHandler"></entry> -->
            </map>
        </property>
    </bean>
 
 
    <!-- Droid -->
    <bean name="ibestatCrawler" class="com.stat4you.crawler.droids.impl.Stat4youPxCrawlingDroid">
        <constructor-arg ref="ibestatQueue" />
        <constructor-arg ref="ibestatTaskMaster" />

        <property name="handlerFactory" ref="ibestatHandlerFactory" />
        <property name="protocolFactory" ref="org.apache.droids.helper.factories.ProtocolFactory" />
        <property name="parserFactory" ref="ibestatParserFactory" />
        <property name="filtersFactory" ref="ibestatFiltersFactory" />
        
        <property name="crawlerInfo" ref="ibestatCrawlerInfo" />
    </bean>


</beans>

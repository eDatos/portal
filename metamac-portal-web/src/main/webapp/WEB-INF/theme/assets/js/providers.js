/*! stat4you-web 2013-07-25 */
(function(){"use strict";STAT4YOU.namespace("STAT4YOU.mixins"),STAT4YOU.mixins.PaginableCollection={_extendFetchOptionsWithPagination:function(e){e=e||{data:this.fetchData};var t={limit:this.limit,offset:this.offset};e&&e.data?_.extend(t,e.data):e.data=t;var n={data:t,traditional:!0,remove:0===this.offset,reset:0===this.offset};return n},_initializePagination:function(){this.limit=this.limit||10,this.offset=this.offset||0},fetchCurrentPage:function(e){this._initializePagination();var t=this._extendFetchOptionsWithPagination(e);return this.fetch(t)},fetchNextPage:function(e){return this._initializePagination(),this.offset=this.offset+this.limit,this.fetchCurrentPage(e)},hasMorePages:function(){return this._initializePagination(),this.offset+this.limit<this.total},parse:function(e){return this.total=e.total,e.items}}})(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.datasets.Dataset"),STAT4YOU.modules.datasets.Dataset=Backbone.Model.extend({idAttribute:"uri",url:function(){return STAT4YOU.apiContext+"/datasets/"+this.get("providerAcronym")+"-"+this.get("identifier")}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.datasets.Datasets"),STAT4YOU.modules.datasets.Datasets=Backbone.Collection.extend({model:STAT4YOU.modules.datasets.Dataset,url:function(){return STAT4YOU.apiContext+"/datasets"}}),STAT4YOU.modules.datasets.Datasets.datasetsFromProvider=function(e){var t=new STAT4YOU.modules.datasets.Datasets;return t.fetchData={query:"ff_ds_prov_acronym='"+e+"'",faceted:!1,mostRecent:!0},t},_.extend(STAT4YOU.modules.datasets.Datasets.prototype,STAT4YOU.mixins.PaginableCollection)}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.datasets.DatasetView"),STAT4YOU.modules.datasets.DatasetView=Backbone.View.extend({className:"dataset-list-el",template:STAT4YOU.templateManager.get("datasets/dataset"),initialize:function(e){STAT4YOU.user&&(this.favourites=STAT4YOU.user.favourites),this.lastFav=!1,this.dataset=e.dataset},events:{"click .fav":"clickFav"},isFav:function(){var e=!1;return this.favourites&&(e=this.favourites.isFav(this.dataset.toJSON())),this.lastFav=e,e},favChange:function(){var e=this.lastFav,t=this.isFav();return e!==t},render:function(){$(".tooltip").remove();var e={dataset:this.dataset.toJSON(),user:STAT4YOU.user,isFavourite:this.isFav()};this.$el.html(this.template(e));var t=this.$(".dataset-list-el-title");_.isFunction(t.dotdotdot)&&t.dotdotdot({watch:window});var n=this.$el.find("a[rel=tooltip]");return _.isFunction(n.tooltip)&&n.tooltip(),this},updateFav:function(){this.favChange()&&this.render()},clickFav:function(){var e=this;return STAT4YOU.doActionIfRegistered(function(){e.favourites&&e.favourites.toggle(e.dataset.get("uri"))}),!1}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.datasets.DatasetsView"),STAT4YOU.modules.datasets.DatasetsView=Backbone.View.extend({template:STAT4YOU.templateManager.get("datasets/datasets"),_defaults:{ellipsis:!0,showViewMore:!1},events:{"click .btn-more":"viewMore"},initialize:function(){STAT4YOU.user&&(this.favourites=STAT4YOU.user.favourites),_.defaults(this.options,this._defaults),this._bindFavouriteEvents(),this.collection.on("reset",this.render,this),this.collection.on("add",this.addDataset,this)},_updateFavsInSubviews:function(){_.each(this._subviews,function(e){e.updateFav()})},_bindFavouriteEvents:function(){this.favourites&&this.favourites.on("add remove reset",this._updateFavsInSubviews,this)},render:function(){this._subviews=[];var e={options:this.options,hasMore:this.collection.hasMorePages()};return this.$el.html(this.template(e)),this.collection.each(this.addDataset,this),this},addDataset:function(e){var t=new STAT4YOU.modules.datasets.DatasetView({dataset:e});this.$el.find(".datasets").append(t.render().el),this._subviews.push(t)},viewMore:function(){this.collection.fetchNextPage()}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.providers.Provider"),STAT4YOU.modules.providers.Provider=Backbone.Model.extend({})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.providers.Providers"),STAT4YOU.modules.providers.Providers=Backbone.Collection.extend({model:STAT4YOU.modules.providers.Provider,findByAcronym:function(e){return this.find(function(t){return t.get("acronym")===e})}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.providers.ProvidersView"),STAT4YOU.modules.providers.ProvidersView=Backbone.View.extend({template:STAT4YOU.templateManager.get("providers/providers"),events:{"click #provider-list a":"navigate"},render:function(){var e={providers:this.collection.toJSON()};return this.$el.html(this.template(e)),this},navigate:function(e){if(!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)){var t=$(e.currentTarget),n=t.attr("href"),i=this.protocol+"//";return n&&n.slice(0,i.length)!==i&&(e.preventDefault(),Backbone.history.navigate(n,!0)),!1}}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.providers.ProviderDetailView");var e=STAT4YOU.modules.datasets.DatasetsView;STAT4YOU.modules.providers.ProviderDetailView=Backbone.View.extend({templatePage:STAT4YOU.templateManager.get("providers/provider-page"),templateError:STAT4YOU.templateManager.get("alerts/error"),initialize:function(e){this.provider=e.provider,this.acronym=e.acronym},render:function(){this.provider?(STAT4YOU.user&&STAT4YOU.user.favourites.fetch(),this._renderProviderInfo()):this._renderError()},_renderProviderInfo:function(){var e={provider:this.provider.toJSON()};$(this.el).html(this.templatePage(e)),this._renderProviderLogo(),this._renderProviderMetadata(),this._renderDatasets()},_renderError:function(){var e={msg:I18n.t("page.providers.notFound",{acronym:this.acronym})};$(this.el).html(this.templateError(e))},_renderProviderLogo:function(){var e=STAT4YOU.templateManager.get("providers/provider-active-provider"),t=this.provider.toJSON();$(".search-active-provider",this.el).html(e(t))},_renderProviderMetadata:function(){var e=STAT4YOU.templateManager.get("providers/provider"),t=this.provider.toJSON();$(".provider",this.el).html(e(t))},_renderDatasets:function(){var t=$(".datasets-list",this.el),n=this.provider.get("acronym"),i=new STAT4YOU.modules.datasets.Datasets.datasetsFromProvider(n);this.datasetView=new e({el:t,collection:i,showViewMore:!0}),this.datasetView.render(),i.fetchCurrentPage()}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.providers.ProvidersRouter");var e=STAT4YOU.modules.providers.ProvidersView,t=STAT4YOU.modules.providers.ProviderDetailView;STAT4YOU.modules.providers.ProvidersRouter=Backbone.Router.extend({initialize:function(e){this.collection=e.collection,this.el=e.el},routes:{":acronym":"detail","":"defaultRoute"},defaultRoute:function(){this.list()},list:function(){this.providersView=new e({el:this.el,collection:this.collection}),this.providersView.render()},detail:function(e){var n=this.collection.findByAcronym(e);this.providersDetailView=new t({el:this.el,provider:n,acronym:e}),this.providersDetailView.render()}})}();
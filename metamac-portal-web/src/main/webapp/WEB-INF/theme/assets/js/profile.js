/*! stat4you-web 2013-07-25 */
(function(e){"function"==typeof define&&define.amd?define(["underscore","jquery","backbone"],e):e(_,$,Backbone)})(function(e,t,n){if(!n)throw"Please include Backbone.js before Backbone.ModelBinder.js";return n.ModelBinder=function(t){e.bindAll(this),this._modelSetOptions=t||{}},n.ModelBinder.VERSION="0.1.5",n.ModelBinder.Constants={},n.ModelBinder.Constants.ModelToView="ModelToView",n.ModelBinder.Constants.ViewToModel="ViewToModel",e.extend(n.ModelBinder.prototype,{bind:function(n,i,r,a){if(this.unbind(),this._model=n,this._rootEl=i,this._modelSetOptions=e.extend({},this._modelSetOptions,a),!this._model)throw"model must be specified";if(!this._rootEl)throw"rootEl must be specified";r?(this._attributeBindings=t.extend(!0,{},r),this._initializeAttributeBindings(),this._initializeElBindings()):this._initializeDefaultBindings(),this._bindModelToView(),this._bindViewToModel()},unbind:function(){this._unbindModelToView(),this._unbindViewToModel(),this._attributeBindings&&(delete this._attributeBindings,this._attributeBindings=void 0)},_initializeAttributeBindings:function(){var t,n,i,r,a;for(t in this._attributeBindings){if(n=this._attributeBindings[t],e.isString(n))i={elementBindings:[{selector:n}]};else if(e.isArray(n))i={elementBindings:n};else{if(!e.isObject(n))throw"Unsupported type passed to Model Binder "+i;i={elementBindings:[n]}}for(r=0;i.elementBindings.length>r;r++)a=i.elementBindings[r],a.attributeBinding=i;i.attributeName=t,this._attributeBindings[t]=i}},_initializeDefaultBindings:function(){var e,n,i,r;for(this._attributeBindings={},n=t("[name]",this._rootEl),e=0;n.length>e;e++)if(i=n[e],r=t(i).attr("name"),this._attributeBindings[r])this._attributeBindings[r].elementBindings.push({attributeBinding:this._attributeBindings[r],boundEls:[i]});else{var a={attributeName:r};a.elementBindings=[{attributeBinding:a,boundEls:[i]}],this._attributeBindings[r]=a}},_initializeElBindings:function(){var e,n,i,r,a,s,o;for(e in this._attributeBindings)for(n=this._attributeBindings[e],i=0;n.elementBindings.length>i;i++){if(r=n.elementBindings[i],a=""===r.selector?t(this._rootEl):t(r.selector,this._rootEl),0===a.length)throw"Bad binding found. No elements returned for binding selector "+r.selector;for(r.boundEls=[],s=0;a.length>s;s++)o=a[s],r.boundEls.push(o)}},_bindModelToView:function(){this._model.on("change",this._onModelChange,this),this.copyModelAttributesToView()},copyModelAttributesToView:function(t){var n,i;for(n in this._attributeBindings)(void 0===t||-1!==e.indexOf(t,n))&&(i=this._attributeBindings[n],this._copyModelToView(i))},_unbindModelToView:function(){this._model&&(this._model.off("change",this._onModelChange),this._model=void 0)},_bindViewToModel:function(){t(this._rootEl).delegate("","change",this._onElChanged),t(this._rootEl).delegate("[contenteditable]","blur",this._onElChanged)},_unbindViewToModel:function(){this._rootEl&&(t(this._rootEl).undelegate("","change",this._onElChanged),t(this._rootEl).undelegate("[contenteditable]","blur",this._onElChanged))},_onElChanged:function(e){var n,i,r,a;for(n=t(e.target)[0],i=this._getElBindings(n),r=0;i.length>r;r++)a=i[r],this._isBindingUserEditable(a)&&this._copyViewToModel(a,n)},_isBindingUserEditable:function(e){return void 0===e.elAttribute||"text"===e.elAttribute||"html"===e.elAttribute},_getElBindings:function(e){var t,n,i,r,a,s,o=[];for(t in this._attributeBindings)for(n=this._attributeBindings[t],i=0;n.elementBindings.length>i;i++)for(r=n.elementBindings[i],a=0;r.boundEls.length>a;a++)s=r.boundEls[a],s===e&&o.push(r);return o},_onModelChange:function(){var e,t;for(e in this._model.changedAttributes())t=this._attributeBindings[e],t&&this._copyModelToView(t)},_copyModelToView:function(e){var i,r,a,s,o=this._model.get(e.attributeName);for(i=0;e.elementBindings.length>i;i++)if(r=e.elementBindings[i],!r.isSetting){var l=this._getConvertedValue(n.ModelBinder.Constants.ModelToView,r,o);for(a=0;r.boundEls.length>a;a++)s=r.boundEls[a],this._setEl(t(s),r,l)}},_setEl:function(e,t,n){t.elAttribute?this._setElAttribute(e,t,n):this._setElValue(e,n)},_setElAttribute:function(t,i,r){switch(i.elAttribute){case"html":t.html(r);break;case"text":t.text(r);break;case"enabled":t.attr("disabled",!r);break;case"displayed":t[r?"show":"hide"]();break;case"hidden":t[r?"hide":"show"]();break;case"css":t.css(i.cssAttribute,r);break;case"class":var a=this._model.previous(i.attributeBinding.attributeName);e.isUndefined(a)||(a=this._getConvertedValue(n.ModelBinder.Constants.ModelToView,i,a),t.removeClass(a)),r&&t.addClass(r);break;default:t.attr(i.elAttribute,r)}},_setElValue:function(e,t){if(e.attr("type"))switch(e.attr("type")){case"radio":e.val()===t&&e.attr("checked","checked");break;case"checkbox":t?e.attr("checked","checked"):e.removeAttr("checked");break;default:e.val(t)}else e.is("input")||e.is("select")||e.is("textarea")?e.val(t):e.text(t)},_copyViewToModel:function(e,n){e.isSetting||(e.isSetting=!0,this._setModel(e,t(n)),e.converter&&this._copyModelToView(e.attributeBinding),e.isSetting=!1)},_getElValue:function(e,t){switch(t.attr("type")){case"checkbox":return t.prop("checked")?!0:!1;default:return void 0!==t.attr("contenteditable")?t.html():t.val()}},_setModel:function(t,i){var r={},a=this._getElValue(t,i);a=this._getConvertedValue(n.ModelBinder.Constants.ViewToModel,t,a),r[t.attributeBinding.attributeName]=a;var s=e.extend({},this._modelSetOptions,{changeSource:"ModelBinder"});this._model.set(r,s)},_getConvertedValue:function(e,t,n){return t.converter&&(n=t.converter(e,n,t.attributeBinding.attributeName,this._model)),n}}),n.ModelBinder.CollectionConverter=function(t){if(this._collection=t,!this._collection)throw"Collection must be defined";e.bindAll(this,"convert")},e.extend(n.ModelBinder.CollectionConverter.prototype,{convert:function(e,t){return e===n.ModelBinder.Constants.ModelToView?t?t.id:void 0:this._collection.get(t)}}),n.ModelBinder.createDefaultBindings=function(e,n,i,r){var a,s,o,l,c={};for(a=t("["+n+"]",e),s=0;a.length>s;s++)if(o=a[s],l=t(o).attr(n),!c[l]){var u={selector:"["+n+'="'+l+'"]'};c[l]=u,i&&(c[l].converter=i),r&&(c[l].elAttribute=r)}return c},n.ModelBinder.combineBindings=function(t,n){e.each(n,function(e,n){var i={selector:e.selector};e.converter&&(i.converter=e.converter),e.elAttribute&&(i.elAttribute=e.elAttribute),t[n]=t[n]?[t[n],i]:i})},n.ModelBinder}),function(){"use strict";STAT4YOU.namespace("STAT4YOU.mixins"),STAT4YOU.mixins.PaginableCollection={_extendFetchOptionsWithPagination:function(e){e=e||{data:this.fetchData};var t={limit:this.limit,offset:this.offset};e&&e.data?_.extend(t,e.data):e.data=t;var n={data:t,traditional:!0,remove:0===this.offset,reset:0===this.offset};return n},_initializePagination:function(){this.limit=this.limit||10,this.offset=this.offset||0},fetchCurrentPage:function(e){this._initializePagination();var t=this._extendFetchOptionsWithPagination(e);return this.fetch(t)},fetchNextPage:function(e){return this._initializePagination(),this.offset=this.offset+this.limit,this.fetchCurrentPage(e)},hasMorePages:function(){return this._initializePagination(),this.offset+this.limit<this.total},parse:function(e){return this.total=e.total,e.items}}}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.datasets.Dataset"),STAT4YOU.modules.datasets.Dataset=Backbone.Model.extend({idAttribute:"uri",url:function(){return STAT4YOU.apiContext+"/datasets/"+this.get("providerAcronym")+"-"+this.get("identifier")}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.datasets.Datasets"),STAT4YOU.modules.datasets.Datasets=Backbone.Collection.extend({model:STAT4YOU.modules.datasets.Dataset,url:function(){return STAT4YOU.apiContext+"/datasets"}}),STAT4YOU.modules.datasets.Datasets.datasetsFromProvider=function(e){var t=new STAT4YOU.modules.datasets.Datasets;return t.fetchData={query:"ff_ds_prov_acronym='"+e+"'",faceted:!1,mostRecent:!0},t},_.extend(STAT4YOU.modules.datasets.Datasets.prototype,STAT4YOU.mixins.PaginableCollection)}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.datasets.DatasetView"),STAT4YOU.modules.datasets.DatasetView=Backbone.View.extend({className:"dataset-list-el",template:STAT4YOU.templateManager.get("datasets/dataset"),initialize:function(e){STAT4YOU.user&&(this.favourites=STAT4YOU.user.favourites),this.lastFav=!1,this.dataset=e.dataset},events:{"click .fav":"clickFav"},isFav:function(){var e=!1;return this.favourites&&(e=this.favourites.isFav(this.dataset.toJSON())),this.lastFav=e,e},favChange:function(){var e=this.lastFav,t=this.isFav();return e!==t},render:function(){$(".tooltip").remove();var e={dataset:this.dataset.toJSON(),user:STAT4YOU.user,isFavourite:this.isFav()};this.$el.html(this.template(e));var t=this.$(".dataset-list-el-title");_.isFunction(t.dotdotdot)&&t.dotdotdot({watch:window});var n=this.$el.find("a[rel=tooltip]");return _.isFunction(n.tooltip)&&n.tooltip(),this},updateFav:function(){this.favChange()&&this.render()},clickFav:function(){var e=this;return STAT4YOU.doActionIfRegistered(function(){e.favourites&&e.favourites.toggle(e.dataset.get("uri"))}),!1}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.datasets.DatasetsView"),STAT4YOU.modules.datasets.DatasetsView=Backbone.View.extend({template:STAT4YOU.templateManager.get("datasets/datasets"),_defaults:{ellipsis:!0,showViewMore:!1},events:{"click .btn-more":"viewMore"},initialize:function(){STAT4YOU.user&&(this.favourites=STAT4YOU.user.favourites),_.defaults(this.options,this._defaults),this._bindFavouriteEvents(),this.collection.on("reset",this.render,this),this.collection.on("add",this.addDataset,this)},_updateFavsInSubviews:function(){_.each(this._subviews,function(e){e.updateFav()})},_bindFavouriteEvents:function(){this.favourites&&this.favourites.on("add remove reset",this._updateFavsInSubviews,this)},render:function(){this._subviews=[];var e={options:this.options,hasMore:this.collection.hasMorePages()};return this.$el.html(this.template(e)),this.collection.each(this.addDataset,this),this},addDataset:function(e){var t=new STAT4YOU.modules.datasets.DatasetView({dataset:e});this.$el.find(".datasets").append(t.render().el),this._subviews.push(t)},viewMore:function(){this.collection.fetchNextPage()}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.profile.ProfileFavouritesView"),STAT4YOU.modules.profile.ProfileFavouritesView=Backbone.View.extend({template:STAT4YOU.templateManager.get("datasets/datasets"),_defaults:{ellipsis:!0,pageSize:3,currentPage:1},events:{"click .btn-more":"viewMore"},initialize:function(e){e=_.extend({},this._defaults,e),this.favourites=STAT4YOU.user.favourites,this.currentPage=e.currentPage,this.pageSize=e.pageSize,this.favourites.on("remove",this._removeFavourite,this)},totalVisibles:function(){var e=this.currentPage*this.pageSize;return e>this.favourites.length?this.favourites.length:e},_visibles:function(){var e=this.favourites.toJSON();return e.slice(0,this.totalVisibles())},hasMore:function(){return this.totalVisibles()<this.favourites.length},_initEllipsis:function(){this.options.ellipsis&&$(".dataset-list-el-title").dotdotdot({watch:window})},_initTooltip:function(){this.$el.find("a[rel=tooltip]").tooltip()},_removeTooltip:function(){$(".tooltip").remove()},render:function(){this._subviews=[];var e=this._visibles(),t={options:this.options,hasMore:this.hasMore()};return this._removeTooltip(),this.$el.html(this.template(t)),e.length>0?(_.each(e,function(e){this.appendDataset(e.dataset)},this),this._initEllipsis(),this._initTooltip()):this.renderInstruction(),this},appendDataset:function(e,t){var n=new STAT4YOU.modules.datasets.Dataset(e),i=new STAT4YOU.modules.datasets.DatasetView({dataset:n});i.render(),t&&i.$el.hide(),this.$el.find(".datasets").append(i.el),this._subviews.push(i),t&&i.$el.fadeIn()},viewMore:function(){var e=this.totalVisibles();this.currentPage++;var t=this.totalVisibles(),n=this._visibles().slice(e,t),i=_.pluck(n,"dataset"),r=this;_.each(i,function(e){r.appendDataset(e,!0)}),this._updateMoreButton()},_updateMoreButton:function(){this.hasMore()||this.$el.find(".btn-more").remove()},_findSubviewIndex:function(e){for(var t,n=-1,i=e.get("dataset").uri,r=0;this._subviews.length>r;r++)if(t=this._subviews[r],t.dataset.get("uri")===i){n=r;break}return n},_removeFavourite:function(e){var t=this._findSubviewIndex(e);if(-1!=t){var n=this._subviews[t];n.$el.fadeOut(_.bind(this._removeFavouriteFadeOutCallback,this,t))}},_removeFavouriteFadeOutCallback:function(e){this._subviews.splice(e,1),this._removeTooltip(),this._updateMoreButton(),this._appendNextDataset(),0===this.totalVisibles()&&this.renderInstruction()},_appendNextDataset:function(){var e=this.totalVisibles();if(e>this._subviews.length){var t=this.favourites.at(e-1).get("dataset");this.appendDataset(t,!0)}},renderInstruction:function(){this.$el.text("No tienes estad√≠sticas favoritas")}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.profile");var e=STAT4YOU.modules.profile.ProfileFavouritesView,t=STAT4YOU.modules.datasets.Datasets;STAT4YOU.modules.profile.ProfileReadView=Backbone.View.extend({template:STAT4YOU.templateManager.get("profile/profile-read"),initialize:function(e){this.user=e.user,this.favourites=e.favourites,this.datasets=new t,this.favourites.on("reset",this._renderFavourites,this)},render:function(){var t=this.user.toJSON();t.locale&&(t.localeLabel=I18n.t("app.lang.names."+t.locale)),this.$el.html(this.template({user:t}));var n=this.$el.find(".favs");this.favsView=new e({el:n,collection:this.datasets,showViewMore:!0,favs:this.favourites,pageSize:10,ellipsis:!0}),this.favourites.fetch({reset:!0})},_renderFavourites:function(){this.datasets.reset(this.favourites.pluck("dataset")),this.favsView.collection=this.datasets,this.favsView.render()}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.profile.ProfileUpdateView"),STAT4YOU.modules.profile.ProfileUpdateView=Backbone.View.extend({template:STAT4YOU.templateManager.get("profile/profile-update"),events:{"submit .profile-update-form":"submit","click .profile-update-cancel":"cancel"},initialize:function(e){this.user=e.user,this.modelBinder=new Backbone.ModelBinder,this.navBarView=STAT4YOU.navbarView,_.bindAll(this,"_userUpdateSuccess","_userUpdateError")},render:function(e){e=e||{},this.newUser=e.newUser===!0,this.updatedUser||(this.updatedUser=this.user.clone());var t={user:this.updatedUser.toJSON(),errors:this.errors};this.$el.html(this.template(t)),this.modelBinder.unbind(),this.modelBinder.bind(this.updatedUser,this.el)},submit:function(){var e=this.user.get("locale")!==this.updatedUser.get("locale"),t=this.user.get("username")!==this.updatedUser.get("username");this.user.set(this.updatedUser.toJSON());var n=this.user.save();return n.done(_.bind(this._userUpdateSuccess,this,e,t)),n.fail(this._userUpdateError),!1},_userUpdateSuccess:function(e,t){if(e){var n=this;n._reloadProfilePage()}else t&&this.navBarView.render(),this._navigateToRead()},_redirectFromLogin:function(){var e=Cookies.get("stat4you.login.redirect"),t=this.newUser&&e;return t?window.location=e:this.newUser=!1,t},_navigateToRead:function(){this._redirectFromLogin()||Backbone.history.navigate("",{trigger:!0})},_reloadProfilePage:function(){this._redirectFromLogin()||(window.location=STAT4YOU.context+"/profile")},_userUpdateError:function(e){var t=$.parseJSON(e.responseText);this.errors={},_.each(t.errors,function(e){this.errors[e.field]||(this.errors[e.field]=[]),this.errors[e.field].push(e.code)},this),this.render()},cancel:function(){return this._navigateToRead(),!1}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.profile"),STAT4YOU.modules.profile.ProfileReadView,STAT4YOU.modules.profile.ProfileUpdateView,STAT4YOU.modules.profile.ProfileRouter=Backbone.Router.extend({initialize:function(e){this.readView=e.readView,this.updateView=e.updateView},routes:{newUser:"newUser",update:"update","":"read"},newUser:function(){this.updateView.render({newUser:!0})},update:function(){this.updateView.render()},read:function(){this.readView.render()}})}();
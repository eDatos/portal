/*! stat4you-web 2013-07-25 */
(function(e){"function"==typeof define&&define.amd?define(["underscore","jquery","backbone"],e):e(_,$,Backbone)})(function(e,t,n){if(!n)throw"Please include Backbone.js before Backbone.ModelBinder.js";return n.ModelBinder=function(t){e.bindAll(this),this._modelSetOptions=t||{}},n.ModelBinder.VERSION="0.1.5",n.ModelBinder.Constants={},n.ModelBinder.Constants.ModelToView="ModelToView",n.ModelBinder.Constants.ViewToModel="ViewToModel",e.extend(n.ModelBinder.prototype,{bind:function(n,i,r,a){if(this.unbind(),this._model=n,this._rootEl=i,this._modelSetOptions=e.extend({},this._modelSetOptions,a),!this._model)throw"model must be specified";if(!this._rootEl)throw"rootEl must be specified";r?(this._attributeBindings=t.extend(!0,{},r),this._initializeAttributeBindings(),this._initializeElBindings()):this._initializeDefaultBindings(),this._bindModelToView(),this._bindViewToModel()},unbind:function(){this._unbindModelToView(),this._unbindViewToModel(),this._attributeBindings&&(delete this._attributeBindings,this._attributeBindings=void 0)},_initializeAttributeBindings:function(){var t,n,i,r,a;for(t in this._attributeBindings){if(n=this._attributeBindings[t],e.isString(n))i={elementBindings:[{selector:n}]};else if(e.isArray(n))i={elementBindings:n};else{if(!e.isObject(n))throw"Unsupported type passed to Model Binder "+i;i={elementBindings:[n]}}for(r=0;i.elementBindings.length>r;r++)a=i.elementBindings[r],a.attributeBinding=i;i.attributeName=t,this._attributeBindings[t]=i}},_initializeDefaultBindings:function(){var e,n,i,r;for(this._attributeBindings={},n=t("[name]",this._rootEl),e=0;n.length>e;e++)if(i=n[e],r=t(i).attr("name"),this._attributeBindings[r])this._attributeBindings[r].elementBindings.push({attributeBinding:this._attributeBindings[r],boundEls:[i]});else{var a={attributeName:r};a.elementBindings=[{attributeBinding:a,boundEls:[i]}],this._attributeBindings[r]=a}},_initializeElBindings:function(){var e,n,i,r,a,s,o;for(e in this._attributeBindings)for(n=this._attributeBindings[e],i=0;n.elementBindings.length>i;i++){if(r=n.elementBindings[i],a=""===r.selector?t(this._rootEl):t(r.selector,this._rootEl),0===a.length)throw"Bad binding found. No elements returned for binding selector "+r.selector;for(r.boundEls=[],s=0;a.length>s;s++)o=a[s],r.boundEls.push(o)}},_bindModelToView:function(){this._model.on("change",this._onModelChange,this),this.copyModelAttributesToView()},copyModelAttributesToView:function(t){var n,i;for(n in this._attributeBindings)(void 0===t||-1!==e.indexOf(t,n))&&(i=this._attributeBindings[n],this._copyModelToView(i))},_unbindModelToView:function(){this._model&&(this._model.off("change",this._onModelChange),this._model=void 0)},_bindViewToModel:function(){t(this._rootEl).delegate("","change",this._onElChanged),t(this._rootEl).delegate("[contenteditable]","blur",this._onElChanged)},_unbindViewToModel:function(){this._rootEl&&(t(this._rootEl).undelegate("","change",this._onElChanged),t(this._rootEl).undelegate("[contenteditable]","blur",this._onElChanged))},_onElChanged:function(e){var n,i,r,a;for(n=t(e.target)[0],i=this._getElBindings(n),r=0;i.length>r;r++)a=i[r],this._isBindingUserEditable(a)&&this._copyViewToModel(a,n)},_isBindingUserEditable:function(e){return void 0===e.elAttribute||"text"===e.elAttribute||"html"===e.elAttribute},_getElBindings:function(e){var t,n,i,r,a,s,o=[];for(t in this._attributeBindings)for(n=this._attributeBindings[t],i=0;n.elementBindings.length>i;i++)for(r=n.elementBindings[i],a=0;r.boundEls.length>a;a++)s=r.boundEls[a],s===e&&o.push(r);return o},_onModelChange:function(){var e,t;for(e in this._model.changedAttributes())t=this._attributeBindings[e],t&&this._copyModelToView(t)},_copyModelToView:function(e){var i,r,a,s,o=this._model.get(e.attributeName);for(i=0;e.elementBindings.length>i;i++)if(r=e.elementBindings[i],!r.isSetting){var l=this._getConvertedValue(n.ModelBinder.Constants.ModelToView,r,o);for(a=0;r.boundEls.length>a;a++)s=r.boundEls[a],this._setEl(t(s),r,l)}},_setEl:function(e,t,n){t.elAttribute?this._setElAttribute(e,t,n):this._setElValue(e,n)},_setElAttribute:function(t,i,r){switch(i.elAttribute){case"html":t.html(r);break;case"text":t.text(r);break;case"enabled":t.attr("disabled",!r);break;case"displayed":t[r?"show":"hide"]();break;case"hidden":t[r?"hide":"show"]();break;case"css":t.css(i.cssAttribute,r);break;case"class":var a=this._model.previous(i.attributeBinding.attributeName);e.isUndefined(a)||(a=this._getConvertedValue(n.ModelBinder.Constants.ModelToView,i,a),t.removeClass(a)),r&&t.addClass(r);break;default:t.attr(i.elAttribute,r)}},_setElValue:function(e,t){if(e.attr("type"))switch(e.attr("type")){case"radio":e.val()===t&&e.attr("checked","checked");break;case"checkbox":t?e.attr("checked","checked"):e.removeAttr("checked");break;default:e.val(t)}else e.is("input")||e.is("select")||e.is("textarea")?e.val(t):e.text(t)},_copyViewToModel:function(e,n){e.isSetting||(e.isSetting=!0,this._setModel(e,t(n)),e.converter&&this._copyModelToView(e.attributeBinding),e.isSetting=!1)},_getElValue:function(e,t){switch(t.attr("type")){case"checkbox":return t.prop("checked")?!0:!1;default:return void 0!==t.attr("contenteditable")?t.html():t.val()}},_setModel:function(t,i){var r={},a=this._getElValue(t,i);a=this._getConvertedValue(n.ModelBinder.Constants.ViewToModel,t,a),r[t.attributeBinding.attributeName]=a;var s=e.extend({},this._modelSetOptions,{changeSource:"ModelBinder"});this._model.set(r,s)},_getConvertedValue:function(e,t,n){return t.converter&&(n=t.converter(e,n,t.attributeBinding.attributeName,this._model)),n}}),n.ModelBinder.CollectionConverter=function(t){if(this._collection=t,!this._collection)throw"Collection must be defined";e.bindAll(this,"convert")},e.extend(n.ModelBinder.CollectionConverter.prototype,{convert:function(e,t){return e===n.ModelBinder.Constants.ModelToView?t?t.id:void 0:this._collection.get(t)}}),n.ModelBinder.createDefaultBindings=function(e,n,i,r){var a,s,o,l,c={};for(a=t("["+n+"]",e),s=0;a.length>s;s++)if(o=a[s],l=t(o).attr(n),!c[l]){var u={selector:"["+n+'="'+l+'"]'};c[l]=u,i&&(c[l].converter=i),r&&(c[l].elAttribute=r)}return c},n.ModelBinder.combineBindings=function(t,n){e.each(n,function(e,n){var i={selector:e.selector};e.converter&&(i.converter=e.converter),e.elAttribute&&(i.elAttribute=e.elAttribute),t[n]=t[n]?[t[n],i]:i})},n.ModelBinder}),function(){"use strict";STAT4YOU.namespace("STAT4YOU.mixins"),STAT4YOU.mixins.PaginableCollection={_extendFetchOptionsWithPagination:function(e){e=e||{data:this.fetchData};var t={limit:this.limit,offset:this.offset};e&&e.data?_.extend(t,e.data):e.data=t;var n={data:t,traditional:!0,remove:0===this.offset,reset:0===this.offset};return n},_initializePagination:function(){this.limit=this.limit||10,this.offset=this.offset||0},fetchCurrentPage:function(e){this._initializePagination();var t=this._extendFetchOptionsWithPagination(e);return this.fetch(t)},fetchNextPage:function(e){return this._initializePagination(),this.offset=this.offset+this.limit,this.fetchCurrentPage(e)},hasMorePages:function(){return this._initializePagination(),this.offset+this.limit<this.total},parse:function(e){return this.total=e.total,e.items}}}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.mixins"),STAT4YOU.mixins.SelectableCollection={areAllSelected:function(){return this.where({selected:!0}).length===this.length},selectAll:function(){this.each(function(e){e.set("selected",!0)})},unselectAll:function(){this.each(function(e){e.set("selected",!1)})},toggleAllSelection:function(){this.areAllSelected()?this.unselectAll():this.selectAll()}}}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.datasets.Dataset"),STAT4YOU.modules.datasets.Dataset=Backbone.Model.extend({idAttribute:"uri",url:function(){return STAT4YOU.apiContext+"/datasets/"+this.get("providerAcronym")+"-"+this.get("identifier")}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.datasets.Datasets"),STAT4YOU.modules.datasets.Datasets=Backbone.Collection.extend({model:STAT4YOU.modules.datasets.Dataset,url:function(){return STAT4YOU.apiContext+"/datasets"}}),STAT4YOU.modules.datasets.Datasets.datasetsFromProvider=function(e){var t=new STAT4YOU.modules.datasets.Datasets;return t.fetchData={query:"ff_ds_prov_acronym='"+e+"'",faceted:!1,mostRecent:!0},t},_.extend(STAT4YOU.modules.datasets.Datasets.prototype,STAT4YOU.mixins.PaginableCollection)}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.admin.remove"),STAT4YOU.admin.remove.DatasetSelectionCollection=STAT4YOU.modules.datasets.Datasets.extend({initialize:function(){this.on("add",this._selecteByDefault,this)},_selecteByDefault:function(e){e.set("selected",!0)},destroySelected:function(){var e=this.where({selected:!0}),t=_.map(e,function(e){return e.get("uri")});$.ajax({type:"POST",url:STAT4YOU.context+"/app/admin/delete",data:{uris:t}})}}),_.extend(STAT4YOU.admin.remove.DatasetSelectionCollection.prototype,STAT4YOU.mixins.SelectableCollection)}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.admin.remove"),STAT4YOU.admin.remove.RemoveDatasetTableRowView=Backbone.Marionette.ItemView.extend({template:"admin/remove-page-table-row",tagName:"tr",events:{"change input":"toggleInput"},initialize:function(){this.listenTo(this.model,"change",this.render)},toggleInput:function(){this.model.set("selected",this.$("input").prop("checked"))}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.admin.remove"),STAT4YOU.admin.remove.RemoveDatasetsTableView=Backbone.Marionette.CompositeView.extend({template:"admin/remove-page-table",itemView:STAT4YOU.admin.remove.RemoveDatasetTableRowView,itemViewContainer:"tbody",events:{"submit .datasetDeleteForm":"deleteDatasets","change .select-all":"toggleSelectAll"},initialize:function(){this.listenTo(this.collection,"change",this.updateView)},deleteDatasets:function(e){e.preventDefault(),this.collection.destroySelected()},toggleSelectAll:function(){this.collection.toggleAllSelection()},updateView:function(){this.$(".select-all").prop("checked",this.collection.areAllSelected())}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.admin.remove"),STAT4YOU.admin.remove.RemoveStateModel=Backbone.Model.extend({})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.admin.remove"),STAT4YOU.admin.remove.RemoveView=Backbone.View.extend({template:STAT4YOU.templateManager.get("admin/remove-page"),datasets:new STAT4YOU.admin.remove.DatasetSelectionCollection,events:{"submit .datasetSearchForm":"updateDatasetQuery"},initialize:function(){this.modelBinder=new Backbone.ModelBinder},render:function(){var e={datasets:this.datasets.toJSON()};this.$el.html(this.template(e)),this.modelBinder.unbind(),this.modelBinder.bind(this.options.deleteFormModel,this.$(".datasetSearchForm"));var t=new STAT4YOU.admin.remove.RemoveDatasetsTableView({collection:this.datasets});t.render(),this.$(".datasets-list").append(t.el)},updateDatasetQuery:function(e){e.preventDefault();var t=this.options.deleteFormModel.get("criteria"),n=this.options.deleteFormModel.get("limit");this.datasets.reset([]),this.datasets.fetch({data:{criteria:t,limit:n}})}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.admin.remove"),STAT4YOU.admin.remove.RemoveRouter=Backbone.Router.extend({initialize:function(e){this.el=e.el,this.model=new STAT4YOU.admin.remove.RemoveStateModel({limit:50}),this.view=new STAT4YOU.admin.remove.RemoveView({el:this.el,deleteFormModel:this.model})},routes:{"":"defaultRoute"},defaultRoute:function(){this.view.render()}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.admin.status"),STAT4YOU.modules.admin.status.StatusModel=Backbone.Model.extend({idAttribute:"name",parse:function(e){return e.fireDate=new Date(e.fireDate),e}})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.admin.status"),STAT4YOU.modules.admin.status.StatusCollection=Backbone.Collection.extend({model:STAT4YOU.modules.admin.status.StatusModel,url:STAT4YOU.context+"/app/admin/status"})}(),function(){"use strict";STAT4YOU.namespace("STAT4YOU.modules.admin.status");var e="running";STAT4YOU.modules.admin.status.StatusView=Backbone.View.extend({initialize:function(){this.listenTo(this.collection,"add",this.add),this.listenTo(this.collection,"remove",this.remove)},className:function(e){var t=e.get("name");return"."+t.slice(0,t.indexOf("."))+"-status"},add:function(t){var n=this.$(this.className(t));n.addClass(e),n.html("<span class='label label-important'>Running since "+t.get("fireDate")+"</span>")},remove:function(t){var n=this.$(this.className(t));n.removeClass(e),n.html("")}})}();